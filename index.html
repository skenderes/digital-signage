<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
  <meta charset="utf-8">
  <title>Digital Signage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #000;
      height: 100%;
      overflow: hidden;
    }
    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
	/* Slideshow media only (do NOT apply to UI elements like QR codes) */
	#container > img,
	#container > video,
	#container > iframe {
	  position: absolute;
	  top: 0; left: 0;
	  width: 100%;
	  height: 100%;
	  object-fit: contain;
	  background: #000;
	}
	  /* FADE-IN / FADE-OUT */
	  .fade {
		opacity: 0;
		transition: opacity 1s ease-in-out;
	  }
	  .fade.visible {
		opacity: 1;
	  }
	/* ===== social layout and phone (high-specificity, replace existing) ===== */
	#container > .social-slide {
  		width: 100%;
  		height: 100%;
  		display: flex;
  		align-items: center;
  		justify-content: space-between;
  		gap: 3rem;
  		padding: 4vh 6vw;
  		box-sizing: border-box;
	}

	/* left column for CTA/QR */
	#container > .social-slide .social-left {
  		flex: 1 1 46%;
  		min-width: 280px;
  		height: 100%;
  		display: flex;
  		flex-direction: column;
  		justify-content: center;
  		align-items: flex-start;
  		padding-left: 1rem;
 		color: #fff;
	}
	/* Left column typography + QR box */
	.social-left .cta-title {
  		font: 700 2.1rem/1.05 system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  		color: #ffffff;
  		margin: 0 0 0.5rem 0;
	}

	.social-left .cta-sub {
  		font: 500 1.1rem/1.4 system-ui, sans-serif;
  		color: #e6e6e6;
  		margin: 0 0 1.25rem 0;
  		max-width: 46ch;
	}

	/* CTA button style (non-clickable visual for signage) */
	.social-left .cta-btn {
  		display: inline-block;
  		padding: 0.6rem 1rem;
  		border-radius: 10px;
  		background: linear-gradient(180deg,#ff5a5f,#e04347);
  		color: white;
  		font-weight: 700;
  		text-decoration: none;
  		margin-bottom: 1.25rem;
  		box-shadow: 0 6px 18px rgba(0,0,0,0.25);
	}

	/* QR area */
	.social-left .qr-area {
  		display: flex;
  		gap: 1rem;
  		align-items: center;
	}

	/* QR container: fixed square, centered content */
	.social-left .qr-box {
	  width: 160px;              /* outer white box size */
	  height: 160px;
	  padding: 8px;              /* inner padding */
	  border-radius: 12px;
	  background: #fff;
	  display: grid;
	  place-items: center;
	  box-shadow: 0 8px 20px rgba(0,0,0,0.18);
	  flex: 0 0 auto;            /* prevent flex from stretching the box */
	  box-sizing: border-box;
	  overflow: hidden;          /* make sure QR can't overflow */
	}
	
	/* The inner element where QRCode writes the canvas/SVG */
	.social-left .qr-box > div {
	  width: 144px;              /* must match QR size below */
	  height: 144px;
	  display: block;
	  line-height: 0;            /* avoid extra inline spacing */
	}

	.social-left .qr-caption {
  		color: #ddd;
  		font: 600 1rem/1.2 system-ui, sans-serif;
  		max-width: 18rem;
	}

	/* small responsiveness: reduce sizes on narrow screens */
	@media (max-width: 800px) {
 		.social-left .cta-title { font-size: 1.6rem; }
  		.social-left .qr-box { width: 120px; height: 120px; }
	}


	/* right column holds the phone and forces its width */
	#container > .social-slide .social-right {
  		flex: 0 0 auto;
  		width: min(42vw, 520px);  /* control phone width */
  		display: flex;
  		justify-content: center;
  		align-items: center;
  		height: 100%;
  		box-sizing: border-box;
	}

	/* phone frame: height-driven sizing to avoid touching bottom */
	#container > .social-slide .social-right .phone-frame {
  		height: 68vh;               /* primary control: shorter phone */
  		aspect-ratio: 9 / 18;       /* slightly wider visual ratio */
  		max-width: 520px;
  		margin: 0 auto;
  		border-radius: 36px;
  		background: #111;
  		border: 10px solid #222;
  		box-shadow: 0 10px 40px rgba(0,0,0,0.6);
  		overflow: hidden;
  		position: relative;
  		display: flex;
  		align-items: center;
  		justify-content: center;
	}

	/* ensure phone screen & viewport behave predictably */
	#container > .social-slide .phone-screen {
  		position: absolute;
  		inset: 0;
  		padding-top: 18px;
  		background: var(--phone-bg, #f8f8f8);
  		display: flex;
  		justify-content: center;
  		align-items: flex-start;
  		box-sizing: border-box;
	}

	#container > .social-slide .phone-viewport {
  		width: 390px;
  		max-width: 100%;
  		height: calc(100% - 18px);
  		box-sizing: border-box;
	}

	#container > .social-slide .phone-viewport iframe {
  		width: 100%;
  		height: 100%;
  		border: 0;
  		display: block;
  		background: transparent;
	}
	/* === FINAL COLOR THEMING FOR SOCIAL SLIDE === */

	/* Entire slide background (optional safety) */
	#container > .social-slide {
	  background: transparent;
	}
	
	/* Left column: white background with black text */
	#container > .social-slide .social-left {
	  background: #ffffff;
	  color: #000000;
	  padding: 3rem;
	  border-radius: 16px; /* optional: soft edge */
	}
	
	/* Ensure all left-column text is black */
	#container > .social-slide .social-left .cta-title,
	#container > .social-slide .social-left .cta-sub,
	#container > .social-slide .social-left .qr-caption {
	  color: #000000;
	}
	
	/* Optional: adjust CTA button to match crimson theme */
	#container > .social-slide .social-left .cta-btn {
	  background: #990000;
	  color: #ffffff;
	}
	
	/* Right column: crimson background behind the phone */
	#container > .social-slide .social-right {
	  background: #990000;
	  padding: 3rem;
	  border-radius: 16px; /* optional: soft edge */
	}
	
	}
  </style>
</head>
<body>
  <div id="container"></div>
<script>
const PLAYLIST_URL = 'playlist.json';
let items = [], idx = 0;

async function fetchPlaylist() {
  try {
    const res = await fetch(PLAYLIST_URL, { cache: 'no-cache' });
    items = await res.json();
  } catch (e) {
    console.error('Failed to load playlist:', e);
  }
}

function fadeOut(el, callback) {
  el.classList.remove('visible');
  // match this to your CSS transition duration (e.g. 1000 or 2000ms)
  setTimeout(callback, 1000);
}

function next() {
  idx = (idx + 1) % items.length;
  showItem(idx);
}

async function showItem(i) {
  const container = document.getElementById('container');
  const prev = container.firstChild;
  const item = items[i];
  let el;

  // 1) Create the right element and set its src
  if (item.type === 'image') {
    el = document.createElement('img');
    el.src = item.src;
  }
  else if (item.type === 'video') {
    el = document.createElement('video');
    el.src = item.src;
    el.autoplay = true;
    el.muted = true;
    el.playsInline = true;
    // when video ends, fade out then go next
    el.onended = () => fadeOut(el, next);
  }
  else if (item.type === 'iframe' && item.phone === true) {
  // outer slide container (left = content, right = phone)
  el = document.createElement('div');
  el.className = 'social-slide';

  // left column (empty for now)
  const leftCol = document.createElement('div');
  leftCol.className = 'social-left';

	const title = document.createElement('h1');
	title.className = 'cta-title';
	title.textContent = item.ctaTitle || 'Follow the Department on Instagram';

	const sub = document.createElement('div');
	sub.className = 'cta-sub';
	sub.textContent = item.ctaSub || 'See our latest news, events, and student highlights. Scan the QR to follow us.';

	const btn = document.createElement('div');
	btn.className = 'cta-btn';
	btn.textContent = item.ctaButtonText || 'Follow @YourDept';

	// QR area
	const qrArea = document.createElement('div');
	qrArea.className = 'qr-area';

	const qrBox = document.createElement('div');
	qrBox.className = 'qr-box';
	// give the QR div an id unique to this slide so multiple slides won't collide
	const qrId = 'qr-' + Math.floor(Math.random() * 1e9);
	const qrInner = document.createElement('div');
	qrInner.id = qrId;

	qrBox.appendChild(qrInner);

	// caption next to QR
	const qcap = document.createElement('div');
	qcap.className = 'qr-caption';
	qcap.textContent = item.qrCaption || 'Scan to follow us on Instagram';

	qrArea.appendChild(qrBox);
	qrArea.appendChild(qcap);

	// append content to leftCol
	leftCol.appendChild(title);
	leftCol.appendChild(sub);
	leftCol.appendChild(btn);
	leftCol.appendChild(qrArea);


  // right column
  const rightCol = document.createElement('div');
  rightCol.className = 'social-right';

  // phone frame
  const phone = document.createElement('div');
  phone.className = 'phone-frame';

  // phone notch (hidden if you removed notch styles)
  const notch = document.createElement('div');
  notch.className = 'phone-notch';

  const screen = document.createElement('div');
  screen.className = 'phone-screen';

  const viewport = document.createElement('div');
  viewport.className = 'phone-viewport';

  // iframe
  const iframe = document.createElement('iframe');
  iframe.src = item.src;
  iframe.loading = 'lazy';
  iframe.allow = 'encrypted-media; clipboard-write; picture-in-picture; web-share';
  iframe.style.background = 'transparent';

  // optional loader
  const loader = document.createElement('div');
  loader.className = 'iframe-loader';
  loader.textContent = item.loadingText || 'Loading feed…';

  // assemble
  viewport.appendChild(iframe);
  screen.appendChild(viewport);
  phone.appendChild(notch);
  phone.appendChild(screen);
  phone.appendChild(loader);

  rightCol.appendChild(phone);
  el.appendChild(leftCol);
  el.appendChild(rightCol);
  
	// Try to create QR (QRCode library must be loaded on the page)
	try {
	  // small delay so the DOM is ready (leftCol is appended earlier)
	  setTimeout(() => {
		const followUrl = item.followUrl || 'https://www.instagram.com/iuiearth.env.sciences/';
		const qrTarget = document.getElementById(qrId);
		if (qrTarget && window.QRCode) {
		  // clear any previous content (defensive)
		  qrTarget.innerHTML = '';
		  new QRCode(qrTarget, {
			text: followUrl,
			width: 144, height: 144,
			correctLevel: QRCode.CorrectLevel.M
		  });
		} else {
		  console.warn('QR target not found or QRCode lib missing', qrId);
		}
	  }, 100);
	} catch (e) {
	  console.warn('QR generation failed', e);
	}


  // remove loader when iframe loads
  iframe.addEventListener('load', () => {
    setTimeout(() => {
      if (loader && loader.parentNode) loader.parentNode.removeChild(loader);
    }, 300);
  });

  // safety fallback
  setTimeout(() => {
    if (loader && loader.parentNode) {
      console.warn('Instagram iframe still not loaded after timeout');
    }
  }, 8000);
}


  else if (item.type === 'iframe') {
    el = document.createElement('iframe');
    el.src = item.src;
  }
  else {
    // unknown type — show placeholder
    el = document.createElement('div');
    el.textContent = 'Unsupported slide type';
    el.style.color = '#fff';
    el.style.display = 'grid';
    el.style.placeItems = 'center';
    el.style.height = '100%';
  }

  // 2) Add fade classes and append
  el.classList.add('fade');
  container.appendChild(el);

  // 3) Trigger the fade-in
  void el.offsetWidth;
  el.classList.add('visible');

  // 4) Start playback or schedule timeout
  if (item.type === 'video') {
    el.play().catch(() => {});
  } else {
    setTimeout(() => fadeOut(el, next), item.duration ?? 10000);
  }

  // 5) Clean up previous slide (after fade duration)
  if (prev) setTimeout(() => container.removeChild(prev), 1000);
}

async function start() {
  await fetchPlaylist();
  if (!items.length) {
    console.error('Playlist is empty');
    return;
  }
  // Kick off the first slide
  showItem(0);

  // 1) Refresh the playlist JSON every 5 minutes
  setInterval(fetchPlaylist, 5 * 60 * 1000);

  // 2) Reload the entire page every 4 hours to clear any hiccups
  setInterval(() => {
    console.log('Performing periodic reload');
    location.reload();
  }, 4 * 60 * 60 * 1000);
}

start();
</script>
</body>
</html>
