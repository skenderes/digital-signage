<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Digital Signage</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #000;
      height: 100%;
      overflow: hidden;
    }
    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
    }
    img, video, iframe {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: contain;
      background: #000;
    }
	  /* FADE-IN / FADE-OUT */
	  .fade {
		opacity: 0;
		transition: opacity 1s ease-in-out;
	  }
	  .fade.visible {
		opacity: 1;
	  }
	/* ===== social layout and phone (high-specificity, replace existing) ===== */
	#container > .social-slide {
  		width: 100%;
  		height: 100%;
  		display: flex;
  		align-items: center;
  		justify-content: space-between;
  		gap: 3rem;
  		padding: 4vh 6vw;
  		box-sizing: border-box;
	}

	/* left column for CTA/QR */
	#container > .social-slide .social-left {
  		flex: 1 1 46%;
  		min-width: 280px;
  		height: 100%;
  		display: flex;
  		flex-direction: column;
  		justify-content: center;
  		align-items: flex-start;
  		padding-left: 1rem;
 		color: #fff;
	}

	/* right column holds the phone and forces its width */
	#container > .social-slide .social-right {
  		flex: 0 0 auto;
  		width: min(42vw, 520px);  /* control phone width */
  		display: flex;
  		justify-content: center;
  		align-items: center;
  		height: 100%;
  		box-sizing: border-box;
	}

	/* phone frame: height-driven sizing to avoid touching bottom */
	#container > .social-slide .social-right .phone-frame {
  		height: 68vh;               /* primary control: shorter phone */
  		aspect-ratio: 9 / 18;       /* slightly wider visual ratio */
  		max-width: 520px;
  		margin: 0 auto;
  		border-radius: 36px;
  		background: #111;
  		border: 10px solid #222;
  		box-shadow: 0 10px 40px rgba(0,0,0,0.6);
  		overflow: hidden;
  		position: relative;
  		display: flex;
  		align-items: center;
  		justify-content: center;
	}

	/* ensure phone screen & viewport behave predictably */
	#container > .social-slide .phone-screen {
  		position: absolute;
  		inset: 0;
  		padding-top: 18px;
  		background: var(--phone-bg, #f8f8f8);
  		display: flex;
  		justify-content: center;
  		align-items: flex-start;
  		box-sizing: border-box;
	}

	#container > .social-slide .phone-viewport {
  		width: 390px;
  		max-width: 100%;
  		height: calc(100% - 18px);
  		box-sizing: border-box;
	}

	#container > .social-slide .phone-viewport iframe {
  		width: 100%;
  		height: 100%;
  		border: 0;
  		display: block;
  		background: transparent;
	}

}
  </style>
</head>
<body>
  <div id="container"></div>
<script>
const PLAYLIST_URL = 'playlist.json';
let items = [], idx = 0;

async function fetchPlaylist() {
  try {
    const res = await fetch(PLAYLIST_URL, { cache: 'no-cache' });
    items = await res.json();
  } catch (e) {
    console.error('Failed to load playlist:', e);
  }
}

function fadeOut(el, callback) {
  el.classList.remove('visible');
  // match this to your CSS transition duration (e.g. 1000 or 2000ms)
  setTimeout(callback, 1000);
}

function next() {
  idx = (idx + 1) % items.length;
  showItem(idx);
}

async function showItem(i) {
  const container = document.getElementById('container');
  const prev = container.firstChild;
  const item = items[i];
  let el;

  // 1) Create the right element and set its src
  if (item.type === 'image') {
    el = document.createElement('img');
    el.src = item.src;
  }
  else if (item.type === 'video') {
    el = document.createElement('video');
    el.src = item.src;
    el.autoplay = true;
    el.muted = true;
    el.playsInline = true;
    // when video ends, fade out then go next
    el.onended = () => fadeOut(el, next);
  }
  else if (item.type === 'iframe' && item.phone === true) {
  // outer slide container (left = content, right = phone)
  el = document.createElement('div');
  el.className = 'social-slide';

  // left column (empty for now)
  const leftCol = document.createElement('div');
  leftCol.className = 'social-left';
  // you can later append text/QR into leftCol

  // right column
  const rightCol = document.createElement('div');
  rightCol.className = 'social-right';

  // phone frame
  const phone = document.createElement('div');
  phone.className = 'phone-frame';

  // phone notch (hidden if you removed notch styles)
  const notch = document.createElement('div');
  notch.className = 'phone-notch';

  const screen = document.createElement('div');
  screen.className = 'phone-screen';

  const viewport = document.createElement('div');
  viewport.className = 'phone-viewport';

  // iframe
  const iframe = document.createElement('iframe');
  iframe.src = item.src;
  iframe.loading = 'lazy';
  iframe.allow = 'encrypted-media; clipboard-write; picture-in-picture; web-share';
  iframe.style.background = 'transparent';

  // optional loader
  const loader = document.createElement('div');
  loader.className = 'iframe-loader';
  loader.textContent = item.loadingText || 'Loading feed…';

  // assemble
  viewport.appendChild(iframe);
  screen.appendChild(viewport);
  phone.appendChild(notch);
  phone.appendChild(screen);
  phone.appendChild(loader);

  rightCol.appendChild(phone);
  el.appendChild(leftCol);
  el.appendChild(rightCol);

  // remove loader when iframe loads
  iframe.addEventListener('load', () => {
    setTimeout(() => {
      if (loader && loader.parentNode) loader.parentNode.removeChild(loader);
    }, 300);
  });

  // safety fallback
  setTimeout(() => {
    if (loader && loader.parentNode) {
      console.warn('Instagram iframe still not loaded after timeout');
    }
  }, 8000);
}


  else if (item.type === 'iframe') {
    el = document.createElement('iframe');
    el.src = item.src;
  }
  else {
    // unknown type — show placeholder
    el = document.createElement('div');
    el.textContent = 'Unsupported slide type';
    el.style.color = '#fff';
    el.style.display = 'grid';
    el.style.placeItems = 'center';
    el.style.height = '100%';
  }

  // 2) Add fade classes and append
  el.classList.add('fade');
  container.appendChild(el);

  // 3) Trigger the fade-in
  void el.offsetWidth;
  el.classList.add('visible');

  // 4) Start playback or schedule timeout
  if (item.type === 'video') {
    el.play().catch(() => {});
  } else {
    setTimeout(() => fadeOut(el, next), item.duration ?? 10000);
  }

  // 5) Clean up previous slide (after fade duration)
  if (prev) setTimeout(() => container.removeChild(prev), 1000);
}

async function start() {
  await fetchPlaylist();
  if (!items.length) {
    console.error('Playlist is empty');
    return;
  }
  // Kick off the first slide
  showItem(0);

  // 1) Refresh the playlist JSON every 5 minutes
  setInterval(fetchPlaylist, 5 * 60 * 1000);

  // 2) Reload the entire page every 4 hours to clear any hiccups
  setInterval(() => {
    console.log('Performing periodic reload');
    location.reload();
  }, 4 * 60 * 60 * 1000);
}

start();
</script>
</body>
</html>
